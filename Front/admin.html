<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - AgriSmart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/admin.css">
</head>

<body class="admin-body">
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2><i class="fa-solid fa-shield-halved"></i> Admin Panel</h2>
                <p>Gestion AgriSmart</p>
            </div>
            <ul class="sidebar-menu">
                <li>
                    <a href="#dashboard" class="active" onclick="showSection('dashboard')">
                        <span class="menu-icon"><i class="fa-solid fa-chart-pie"></i></span>
                        Tableau de bord
                    </a>
                </li>
                <li>
                    <a href="#users" onclick="showSection('users')">
                        <span class="menu-icon"><i class="fa-solid fa-users"></i></span>
                        Utilisateurs
                        <span class="menu-badge" id="pendingBadge">0</span>
                    </a>
                </li>
                <li>
                    <a href="#statistics" onclick="showSection('statistics')">
                        <span class="menu-icon"><i class="fa-solid fa-chart-line"></i></span>
                        Statistiques March√©
                    </a>
                </li>
                <li>
                    <a href="#reclamations" onclick="showSection('reclamations')">
                        <span class="menu-icon"><i class="fa-solid fa-clipboard-list"></i></span>
                        R√©clamations
                        <span class="menu-badge" id="reclamationsBadge">0</span>
                    </a>
                </li>
            </ul>
            
            <!-- Bouton de d√©connexion -->
            <div class="sidebar-logout">
                <button onclick="logout(); return false;" class="sidebar-logout-btn">
                    <i class="fa-solid fa-sign-out-alt"></i>
                    D√©connexion
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <div>
                    <h1>Bienvenue, Administrateur</h1>
                    <p>G√©rez votre plateforme AgriSmart</p>
                </div>
                <div class="header-date" id="currentDate"></div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboard" class="admin-section active">
                <h2 class="section-title"><i class="fa-solid fa-chart-pie"></i> Tableau de Bord</h2>

                <div class="stats-overview" id="adminStats">
                    <!-- Stats will be loaded here -->
                </div>

                <div class="card admin-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fa-solid fa-hourglass-half"></i> Utilisateurs en Attente
                            d'Approbation</h3>
                    </div>
                    <div id="pendingUsers">
                        <p>Chargement...</p>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users" class="admin-section">
                <h2 class="section-title"><i class="fa-solid fa-users"></i> Gestion des Utilisateurs</h2>

                <div class="card admin-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fa-solid fa-check"></i> Utilisateurs Accept√©s</h3>
                    </div>
                    <div id="acceptedUsers">
                        <p>Chargement...</p>
                    </div>
                </div>

                <div class="card admin-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fa-solid fa-list"></i> Tous les Utilisateurs</h3>
                    </div>
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label>R√¥le:</label>
                            <select id="userRoleFilter" class="form-control">
                                <option value="all">Tous</option>
                                <option value="farmer">Agriculteurs</option>
                                <option value="consumer">Consommateurs</option>
                                <option value="vet">V√©t√©rinaires</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Statut:</label>
                            <select id="userStatusFilter" class="form-control" onchange="loadAllUsers()">
                                <option value="all">Tous</option>
                                <option value="pending">En attente</option>
                                <option value="accepted">Accept√©s</option>
                                <option value="rejected">Rejet√©s</option>
                                <option value="suspended">Suspendus</option>
                            </select>
                        </div>
                    </div>
                    <div id="allUsers">
                        <p>Chargement...</p>
                    </div>
                </div>
            </section>

            <!-- Statistics Section -->
            <section id="statistics" class="admin-section">
                <h2 class="section-title"><i class="fa-solid fa-chart-line"></i> Statistiques du March√© Tunisien</h2>

                <div class="card admin-card">
                    <div class="card-header">
                        <h3 class="card-title">Gestion des Cat√©gories</h3>
                        <button class="btn btn-success admin-btn" onclick="openNewStatModal()">
                            <i class="fa-solid fa-plus"></i> Nouvelle cat√©gorie
                        </button>
                    </div>
                    <p class="stats-info-text">
                        Ces statistiques sont affich√©es aux agriculteurs sur leur page de statistiques.
                    </p>
                    <div id="statsManagementGrid" class="stats-management-grid">
                        <p>Chargement des statistiques...</p>
                    </div>
                </div>
            </section>

            <!-- R√©clamations Section -->
            <section id="reclamations" class="admin-section">
                <h2 class="section-title">üìù Gestion des R√©clamations</h2>
                <p class="stats-info-text">
                    Toutes les r√©clamations cr√©√©es par les utilisateurs (fermiers, v√©t√©rinaires, consommateurs) sont
                    affich√©es ici.
                </p>

                <div class="filters-bar">
                    <div class="filter-group">
                        <label>Statut:</label>
                        <select id="reclamationStatusFilter" class="form-control" onchange="displayReclamations()">
                            <option value="all">Toutes</option>
                            <option value="en_attente">En attente</option>
                            <option value="en_cours">En cours</option>
                            <option value="resolue">R√©solues</option>
                            <option value="fermee">Ferm√©es</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Type:</label>
                        <select id="reclamationTypeFilter" class="form-control" onchange="displayReclamations()">
                            <option value="all">Tous</option>
                            <option value="technique">Technique</option>
                            <option value="produit">Produit</option>
                            <option value="service">Service</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>R√¥le:</label>
                        <select id="reclamationRoleFilter" class="form-control" onchange="displayReclamations()">
                            <option value="all">Tous</option>
                            <option value="farmer">Fermiers</option>
                            <option value="vet">V√©t√©rinaires</option>
                            <option value="consumer">Consommateurs</option>
                        </select>
                    </div>
                </div>

                <div class="card admin-card">
                    <div id="reclamationsList">
                        <p>Chargement des r√©clamations...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal R√©pondre √† une R√©clamation -->
    <div id="reclamationResponseModal" class="modal">
        <div class="modal-content admin-modal-content">
            <div class="admin-modal-header">
                <h2>üì© R√©pondre √† la R√©clamation</h2>
                <button class="close" onclick="closeReclamationResponseModal()">&times;</button>
            </div>
            <div class="admin-modal-body">
                <div id="reclamationDetails" class="reclamation-details-box">
                    <!-- Les d√©tails seront charg√©s ici -->
                </div>
                <form id="reclamationResponseForm">
                    <input type="hidden" id="reclamationId">
                    <div class="form-group">
                        <label>Statut</label>
                        <select id="reclamationStatus" class="form-control" required>
                            <option value="en_attente">En attente</option>
                            <option value="en_cours">En cours</option>
                            <option value="resolue">R√©solue</option>
                            <option value="fermee">Ferm√©e</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>R√©ponse</label>
                        <textarea id="reclamationResponse" class="form-control" rows="5"
                            placeholder="Votre r√©ponse √† la r√©clamation..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary admin-btn">üíæ Enregistrer</button>
                        <button type="button" class="btn btn-danger admin-btn" onclick="closeReclamationResponseModal()">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Contacter Utilisateur -->
    <div id="adminContactModal" class="modal">
        <div class="modal-content admin-modal-content">
            <div class="admin-modal-header">
                <h2><i class="fa-solid fa-envelope"></i> Contacter l'utilisateur</h2>
                <button class="close">&times;</button>
            </div>
            <div class="admin-modal-body">
                <form id="adminContactForm">
                    <input type="hidden" id="adminContactUserId">
                    <p><strong>Destinataire:</strong> <span id="adminContactUserName"></span></p>
                    <div class="form-group">
                        <label>Sujet</label>
                        <input type="text" id="adminMessageSubject" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="adminMessageContent" class="form-control" required rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary admin-btn" style="width: 100%;">Envoyer</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Modifier Statistiques -->
    <div id="statModal" class="modal">
        <div class="modal-content admin-modal-content">
            <div class="admin-modal-header">
                <h2>‚úèÔ∏è Modifier: <span id="statCategoryTitle"></span></h2>
                <button class="close">&times;</button>
            </div>
            <div class="admin-modal-body">
                <form id="statForm">
                    <input type="hidden" id="statCategory">
                    <input type="hidden" id="statId">

                    <div id="statPartsContainer"></div>

                    <div id="totalPercentageDisplay" class="total-percentage-display">
                        Total: 0%
                    </div>

                    <button type="button" class="btn btn-secondary admin-btn" onclick="addStatPart()" style="width: 100%; margin-bottom: 1rem;">
                        ‚ûï Ajouter une partie
                    </button>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary admin-btn">üíæ Enregistrer</button>
                        <button type="button" class="btn btn-danger admin-btn" onclick="closeStatModal()">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nouvelle Statistique -->
    <div id="newStatModal" class="modal">
        <div class="modal-content admin-modal-content">
            <div class="admin-modal-header">
                <h2><i class="fa-solid fa-plus"></i> Nouvelle Cat√©gorie</h2>
                <button class="close">&times;</button>
            </div>
            <div class="admin-modal-body">
                <form id="newStatForm">
                    <div class="form-group">
                        <label>Identifiant (minuscules, sans accents)</label>
                        <input type="text" id="newStatCategory" class="form-control" placeholder="Ex: cereales" required
                            pattern="[a-z0-9_]+">
                    </div>

                    <div class="form-group">
                        <label>Nom d'affichage</label>
                        <input type="text" id="newStatDisplayName" class="form-control" placeholder="Ex: C√©r√©ales"
                            required>
                    </div>

                    <div class="form-group">
                        <label>Couleur</label>
                        <input type="color" id="newStatColor" class="form-control" value="#3498db"
                            style="height: 45px; width: 100%;">
                    </div>

                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #eee;">
                    <h4 style="margin-bottom: 1rem; color: #2c3e50;">Donn√©es</h4>

                    <div id="newStatPartsContainer"></div>

                    <div id="newTotalPercentageDisplay" class="total-percentage-display">
                        Total: 0%
                    </div>

                    <button type="button" class="btn btn-secondary admin-btn" onclick="addNewStatPart()" style="width: 100%; margin-bottom: 1rem;">
                        ‚ûï Ajouter une partie
                    </button>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-success admin-btn"><i class="fa-solid fa-check"></i>
                            Cr√©er</button>
                        <button type="button" class="btn btn-danger admin-btn" onclick="closeNewStatModal()">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Suspension Utilisateur -->
    <div id="suspendUserModal" class="modal">
        <div class="modal-content admin-modal-content">
            <div class="admin-modal-header">
                <h2><i class="fa-solid fa-ban"></i> Suspendre l'utilisateur</h2>
                <button class="close" onclick="closeSuspendModal()">&times;</button>
            </div>
            <div class="admin-modal-body">
                <form id="suspendUserForm">
                    <input type="hidden" id="suspendUserId">
                    <p><strong>Utilisateur:</strong> <span id="suspendUserName"></span></p>

                    <div class="form-group">
                        <label>Raison de la suspension *</label>
                        <textarea id="suspensionReason" class="form-control" required rows="3"
                            placeholder="Expliquez pourquoi cet utilisateur est suspendu..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Date de fin de suspension (optionnel)</label>
                        <input type="datetime-local" id="suspensionEndDate" class="form-control">
                        <small style="color: #666; display: block; margin-top: 0.5rem;">
                            Laissez vide pour une suspension ind√©finie
                        </small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-warning admin-btn">
                            <i class="fa-solid fa-ban"></i> Suspendre
                        </button>
                        <button type="button" class="btn btn-secondary admin-btn" onclick="closeSuspendModal()">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="assets/js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/admin.js"></script>

    <script>
        // Navigation entre sections
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            // Update sidebar active state
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            document.querySelector(`a[href="#${sectionId}"]`).classList.add('active');
        }

        // Afficher la date actuelle
        document.getElementById('currentDate').innerHTML = new Date().toLocaleDateString('fr-FR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    </script>
</body>

</html>
