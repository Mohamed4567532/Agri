<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Messages - AgriSmart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/messages.css">
</head>

<body class="farmer-no-bg">
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="assets/img/logo.PNG" alt="AgriSmart Logo">
                <span>AgriSmart</span>
            </a>
            <ul class="nav-menu" id="navMenu">
                <!-- Le menu sera rempli dynamiquement -->
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="messages-container">
            <!-- Header -->
            <div class="messages-header">
                <h1>
                    <i class="fa-solid fa-comments"></i>
                    Mes Messages
                </h1>
                <p>Gérez tous vos messages envoyés et reçus</p>
            </div>

            <!-- Onglets -->
            <div class="messages-tabs">
                <button class="tab-button active" onclick="switchTab('received')" id="tabReceived">
                    <i class="fa-solid fa-inbox"></i>
                    Messages Reçus
                    <span class="badge" id="receivedBadge">0</span>
                </button>
                <button class="tab-button" onclick="switchTab('sent')" id="tabSent">
                    <i class="fa-solid fa-paper-plane"></i>
                    Messages Envoyés
                    <span class="badge" id="sentBadge">0</span>
                </button>
            </div>

            <!-- Filtres -->
            <div class="messages-filters">
                <div class="filter-group">
                    <label><i class="fa-solid fa-filter"></i> Filtrer:</label>
                    <select id="messageFilter" onchange="applyFilter()">
                        <option value="all">Tous</option>
                        <option value="unread">Non lus</option>
                        <option value="read">Lus</option>
                        <option value="withProduct">Avec produit</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fa-solid fa-search"></i> Rechercher:</label>
                    <input type="text" id="messageSearch" placeholder="Rechercher dans les messages..." oninput="applyFilter()">
                </div>
            </div>

            <!-- Liste des messages -->
            <div id="messagesList" class="messages-list">
                <div class="messages-empty-state">
                    <div class="icon"><i class="fa-solid fa-envelope-open"></i></div>
                    <h3>Chargement des messages...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Détails Message -->
    <div id="messageDetailsModal" class="modal" onclick="if(event.target === this) closeMessageModal();">
        <div class="modal-content message-modal-content" onclick="event.stopPropagation();">
            <div class="message-modal-header">
                <h2>
                    <i class="fa-solid fa-envelope"></i>
                    Détails du Message
                </h2>
                <button class="message-modal-close" onclick="closeMessageModal()">&times;</button>
            </div>
            <div class="message-modal-body" id="messageDetailsContent">
                <!-- Les détails seront chargés ici -->
            </div>
            <div id="replySection" class="reply-section">
                <h3>
                    <i class="fa-solid fa-reply"></i>
                    Répondre
                </h3>
                <form id="replyMessageForm" onsubmit="replyToMessageFromModal(event); return false;">
                    <input type="hidden" id="replyMessageId">
                    <input type="hidden" id="replySenderId">
                    <div class="reply-form-group">
                        <label for="replySubject" class="reply-form-label">Sujet *</label>
                        <input type="text" id="replySubject" class="reply-form-input" required>
                    </div>
                    <div class="reply-form-group">
                        <label for="replyContent" class="reply-form-label">Votre réponse *</label>
                        <textarea id="replyContent" class="reply-form-textarea" required rows="5" placeholder="Tapez votre réponse ici..."></textarea>
                    </div>
                    <div class="reply-form-actions">
                        <button type="submit" class="reply-btn-submit">
                            <i class="fa-solid fa-paper-plane"></i> Envoyer la réponse
                        </button>
                        <button type="button" class="reply-btn-cancel" onclick="closeMessageModal()">
                            Annuler
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="assets/js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/messages.js"></script>
    <script>
        // Appliquer le style selon le rôle de l'utilisateur
        function applyUserStyle() {
            const user = getCurrentUser();
            console.log('User detected:', user);
            if (user && user.role === 'consumer') {
                console.log('Applying consumer style to messages page...');
                document.body.classList.remove('farmer-no-bg');
                document.body.classList.add('consumer-page');
            } else if (user && user.role === 'vet') {
                console.log('Applying vet style to messages page...');
                document.body.classList.remove('farmer-no-bg');
                document.body.classList.add('vet-page');
            }
            console.log('Body classes:', document.body.className);
        }
        
        // Appliquer immédiatement
        applyUserStyle();
        
        // Et aussi au chargement du DOM
        document.addEventListener('DOMContentLoaded', applyUserStyle);
    </script>
</body>

</html>
